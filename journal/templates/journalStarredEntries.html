{% extends 'journalBase.html' %}
{% load static %}

    <script>
        function confirmDelete(event, url) {
            event.preventDefault();
            if (confirm('Are you sure you want to delete this entry?')) {
                window.location.href = url;
            }
        }
    // Add updateTable function
    function updateTable() {
        jQuery.ajax({
            url: '{% url 'starredJournalEntry' %}', // Replace this with the URL to your endpoint that returns the updated data
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                // Clear the table data
                app.table.clear().draw();

                // Add the new data to the table
                for (let entry of data) {
                    app.table.row.add([
                        // Replace 'entry.xxx' with the appropriate keys for your data structure
                        entry.star,
                        entry.title,
                        entry.created_at,
                        entry.specialist_access,
                        entry.delete,
                    ]).draw();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching updated data:', error);
            }
        });
    }

    // Modify toggleStar function
    function toggleStar(event, entry_id) {
        event.preventDefault();
        $.ajax({
            url: '{% url "starJournalEntry" %}',
            data: {
                'entry_id': entry_id,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            type: 'POST',
            dataType: 'json',
            success: function (data) {
                // Update the table data after the action is performed
                updateTable();
            },
            error: function(xhr, status, error) {
                console.error('Error toggling star:', error);
            }
        });
    }

    </script>

    </script>
{% block journalcontent %}
<div style="width:100%;background-color:transparent;">
      <div class="bich">
<!-- ENTRIES AREA ENTRIES AREA WITH THE BIG TABLLLLEEEEEEEE -->
            <div class="container">
                <div class="row">
                    <div class="col-md-12 mx-auto d-flex">
                        <input class="form-control" id="textSearch" placeholder="Search entries..." />
                    </div>
                </div>

                <table class="table mt-4" id="journalEntries">
                    <thead class="thead-dark text-center">
                        <tr>
                            <!-- <th>Star</th> -->
                            <th>Title</th>
                            <th>Specialist Access</th>
                            <th>Created At</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody class="text-center">
                        {% for entry in entries %}
                            <tr>
                                <!-- <td>
                                    <a title="{% if entry.isStarred == 1 %}isStarred{% else %}not isStarred{% endif %}" href="#" onclick="toggleStar(event, '{{ entry.id }}')">
                                        <i class="fa {% if entry.isStarred == 1 %} fa-star {% else %} fa-star-o {% endif %}" {% if entry.isStarred == 1 %}style=" color:orange" {% endif %} aria-hidden="true"></i>
                                    </a>
                                </td> -->
                                <td>
            {#                      <a title="Click to open article" href="{% url 'journal_detail' entries.id %}">{{ entries.title }}</a>#}
                                    <a title="Click to open article" href="#">{{ entry.title }}</a>
                                </td>
                                <td>
                                    <span hidden id="jnid{{ entry.id }}">!{{ entry.id }}</span>

                                    {% if entry.status is None %}
                                        <span class="badge badge-secondary">No Request</span>
                                    {% elif entry.status == 0 %}
                                        <button class="journalRequest btn btn-outline-info" value="{{ entry.id }}">Access Request</button>
                                    {% elif entry.status == 1 %}
                                        <span class="badge badge-success">Shared</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.created_at}}</td>
                                <td>
                                    <a title="Delete Article" href="{% url 'delete_journalEntry' entry_id=entry.id %}" onclick="confirmDelete(event, '{% url 'delete_journalEntry' entry_id=entry.id|escapejs %}')">
                                        <i class="fa fa-trash" aria-hidden="true"></i>
                                    </a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7">No records found.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>


            <script>
              $(function() {
                //MODAL EVENTS
                $(".journalRequest").click(function() {
                  var id = $(this).val();
                  // var jnid=$('#jnid'+id).text();
                  var specname = $('#specname' + id).text();
                  var notes = $('#notes' + id).text();

                  $('#journalRequestModal').modal('show');
                  $('#specname').val(specname);
                  $('#notes').val(notes);
                  $('#journalid').val(id);
                })

                var app = (function() {
                  var checkboxInput = ' input[type="checkbox"]',
                    filters = {},
                    rowData = [],
                    values = [],
                    key, value, show, length, divId;

                  var init = function() {
                    app.table = $('#journalEntries').DataTable({
                      "dom": "lrtip" // hide default DataTable search box
                    });

                    $("#textSearch").on('keyup change', function() {
                      console.log('text search for: ' + $(this).val());
                      app.table.search($(this).val()).draw();
                    });

                    $(checkboxInput).prop('checked', false);

                    $(checkboxInput).change(function() {
                      var that = $(this);
                      if (that.hasClass('all')) {
                        $('#' + getFilterCategoryId(that) + checkboxInput).prop('checked', that.prop('checked'));
                      } else {
                        var allInput = $('#' + getFilterCategoryId(that) + checkboxInput + ':first');
                        if (allInput.is(':checked')) {
                          allInput.prop('checked', false);
                        }
                      }
                      poulateAndApplyFilters();
                    });
                  };

                  return {
                    init: init
                  };
                })();

                app.init();

              });
            </script>
      </div>
</div>

{% endblock journalcontent %}
